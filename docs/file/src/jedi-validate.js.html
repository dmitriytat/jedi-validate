<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/jedi-validate.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/dmitriytat/jedi-validate" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">i18n</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/i18n/jedi-validate-i18n.js~Dictionary.html">Dictionary</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ajax">ajax</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertData">convertData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertNameToPath">convertNameToPath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getQueryPart">getQueryPart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createObject">createObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getData">getData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getInputData">getInputData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getInputName">getInputName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getInputValue">getInputValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRadioGroupValue">getRadioGroupValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getValueByName">getValueByName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getValueByPath">getValueByPath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getFormOptions">getFormOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getInputRules">getInputRules</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isCheckable">isCheckable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateData">validateData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateField">validateField</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/jedi-validate.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import deepmerge from &apos;deepmerge&apos;;
import { getData, getInputData, getValueByName } from &apos;./lib/get-data&apos;;
import { convertData } from &apos;./lib/convert-data&apos;;
import Dictionary from &apos;./i18n/jedi-validate-i18n&apos;;
import { getFormOptions, getInputRules } from &apos;./lib/get-options&apos;;
import { validateData, validateField } from &apos;./lib/validate-data&apos;;
import { ajax } from &apos;./lib/ajax&apos;;
import defaultMethods from &apos;./lib/methods&apos;;

class JediValidate {
    /**
     * Object with fields
     * @type {Object.&lt;string, Element&gt;}
     */
    fields = {};
    /**
     * Object with inputs nodes
     * @type {Object.&lt;string, HTMLInputElement|HTMLSelectElement|Array&gt;}
     */
    inputs = {};
    /**
     * Object with message nodes
     * @type {Object.&lt;string, Element&gt;}
     */
    messages = {};
    /**
     * Object with error message
     * @type {Object.&lt;string, Object.&lt;string, string&gt;&gt;}
     */
    errorMessages = {};
    /**
     * Object with error message
     * @type {object} - data object
     */
    data = {};
    /**
     * Validate methods
     * @type {Object.&lt;string, {func: Function, message: string}&gt;}
     */
    methods = { ...defaultMethods };
    /* eslint-disable */
    /**
     * Validator options
     * @type {{ajax: {url: string, enctype: string, sendType: string, method: string}, rules: {}, messages: {}, containers: {parent: string, message: string, baseMessage: string}, states: {error: string, valid: string, pristine: string, dirty: string}, formStatePrefix: string, callbacks: {success: (function(object)), error: (function(object.&lt;string, Array.&lt;string&gt;&gt;))}, clean: boolean, redirect: boolean, language: string, translations: {}}}
     */
    options = {};
    /* eslint-enable */
    /**
     * Validator rules
     * @type {object}
     */
    rules = {};

    /**
     * Translation dictionary
     * @type {Dictionary}
     */
    dictionary = null;

    /**
     * JediValidate
     * @param {HTMLElement} root - element which wrap form element
     * @param {object} options - object with options
     */
    constructor(root, options = {}) {
        const defaultOptions = {
            ajax: {
                url: null,
                enctype: &apos;application/x-www-form-urlencoded&apos;,
                sendType: &apos;serialize&apos;, // &apos;serialize&apos;, &apos;formData&apos;, &apos;json&apos;
                method: &apos;GET&apos;,
            },
            rules: {},
            messages: {},
            containers: {
                parent: &apos;form-group&apos;,
                message: &apos;help-block&apos;,
                baseMessage: &apos;base-error&apos;,
            },
            states: {
                error: &apos;error&apos;,
                valid: &apos;valid&apos;,
                pristine: &apos;pristine&apos;,
                dirty: &apos;dirty&apos;,
            },
            formStatePrefix: &apos;jedi-&apos;,
            callbacks: {
                success({ event, response }) { // eslint-disable-line no-unused-vars
                },
                error({ errors }) { // eslint-disable-line no-unused-vars
                },
            },
            clean: true,
            redirect: true,
            language: &apos;en&apos;,
            translations: {},
        };

        this.root = root;

        this.options = deepmerge(defaultOptions, options);

        this.nodes = JediValidate.cacheNodes(this.root, this.options);

        const formOptions = getFormOptions(this.nodes.form);

        this.options = deepmerge(this.options, defaultOptions);
        this.options = deepmerge(this.options, formOptions);
        this.options = deepmerge(this.options, options);

        this.rules = { ...this.options.rules };

        this.dictionary = new Dictionary(this.options.translations);

        this.ready();

        this.errorMessages = JediValidate.initErrorMessages(
            this.rules,
            this.options.messages,
            this.methods,
            this.options.language,
        );
    }

    /**
     * Return object with working elements
     * @param root Root element for search
     * @param options Object with selectors
     * @returns {{form: HTMLFormElement, inputs: NodeList, baseMessage: Element}}
     */
    static cacheNodes(root, options) {
        return {
            form: root.querySelector(&apos;form&apos;),
            inputs: root.querySelectorAll(&apos;form [name]&apos;),
            baseMessage: root.querySelector(`.${options.containers.baseMessage}`),
        };
    }

    ready() {
        this.nodes.form.setAttribute(&apos;novalidate&apos;, &apos;novalidate&apos;);

        this.nodes.form.addEventListener(&apos;submit&apos;, (event) =&gt; {
            this.data = getData(this.inputs);

            const errors = validateData(
                this.rules,
                this.methods,
                this.data,
                this.errorMessages,
                this.translate,
            );

            if (errors &amp;&amp; Object.keys(errors).filter(name =&gt; errors[name]).length !== 0) {
                Object.keys(errors).forEach(name =&gt;
                    JediValidate.markField(
                        this.fields[name],
                        this.messages[name],
                        this.options.states,
                        errors[name],
                    ),
                );

                try {
                    this.options.callbacks.error({ errors });
                } catch (e) {
                    console.error(e);
                }

                event.preventDefault();
                return;
            }

            if (this.options.ajax &amp;&amp; this.options.ajax.url) {
                event.preventDefault();
            } else {
                try {
                    this.options.callbacks.success({ event });
                } catch (e) {
                    console.error(e);
                }

                return;
            }

            const convertedData = convertData(this.data, this.options.ajax.sendType);
            this.send({
                ...this.options.ajax,
                data: convertedData,
            });
        });

        this.nodes.inputs.forEach((input) =&gt; {
            // fixme &quot;name&quot; and &quot;name in data&quot; not the same
            // name === &quot;phone[]&quot;,
            // data: { phone: [] } - name === &quot;phone&quot;
            const name = input.name;

            if (this.inputs[name]) {
                if (Array.isArray(this.inputs[name])) {
                    this.inputs[name].push(input);
                } else {
                    const groupInput = [this.inputs[name], input];
                    groupInput.name = name;
                    this.inputs[name] = groupInput;
                }
            } else {
                this.inputs[name] = input;

                let field = input.parentNode;

                do {
                    if (field.classList.contains(this.options.containers.parent)) {
                        this.fields[name] = field;
                        break;
                    }

                    field = field.parentNode;
                } while (field &amp;&amp; field.classList);

                if (!this.fields[name]) {
                    console.warn(`Input ${name} has no parent field`);
                    delete this.inputs[name];
                    return;
                }

                this.fields[name].classList.add(this.options.states.pristine);

                const messageElement = this.fields[name].querySelector(`.${this.options.containers.message}`);

                if (messageElement) {
                    this.messages[name] = messageElement;
                } else {
                    this.messages[name] = document.createElement(&apos;div&apos;);
                    this.messages[name].classList.add(this.options.containers.message);
                    this.fields[name].appendChild(this.messages[name]);
                }

                this.rules[name] = this.rules[name] || {};
                const inputRules = getInputRules(input);
                this.rules[name] = deepmerge(inputRules, this.rules[name]);

                Object.keys(this.rules[name]).forEach((rule) =&gt; {
                    if (this.rules[name][rule]) {
                        this.fields[name].classList.add(rule);
                    }
                });
            }

            input.addEventListener(&apos;change&apos;, () =&gt; {
                this.fields[name].classList.remove(this.options.states.dirty);

                const inputData = getInputData(input);
                const value = getValueByName(name, inputData);

                // fixme don&apos;t work with 2 inputs phone[]
                this.data = {
                    ...this.data,
                    ...inputData,
                };

                const errors = validateField(
                    this.rules[name],
                    this.methods,
                    value,
                    name,
                    this.errorMessages,
                    this.data,
                    this.translate,
                );

                JediValidate.markField(
                    this.fields[name],
                    this.messages[name],
                    this.options.states,
                    errors,
                );
            });

            input.addEventListener(&apos;input&apos;, () =&gt; {
                this.fields[name].classList.remove(this.options.states.pristine);
                this.fields[name].classList.add(this.options.states.dirty);
            });
        });
    }

    /**
     * Translate
     * @param {string} text - text to translate
     */
    translate = text =&gt; this.dictionary.translate(text, this.options.language);

    /**
     * Send form
     * @param {object} options - object with options for sending
     * @param {string} options.url
     * @param {string} options.enctype
     * @param {string} options.sendType
     * @param {string} options.method
     * @param {string|FormData} options.data
     */
    send(options) {
        ajax(options).then((response) =&gt; {
            if (response.validationErrors) {
                try {
                    this.options.callbacks.error({ errors: response.validationErrors });
                } catch (e) {
                    console.error(e);
                }

                if (response.validationErrors.base) {
                    this.nodes.baseMessage.innerHTML = response.validationErrors.base.join(&apos;, &apos;);
                    this.root.classList.add(this.options.formStatePrefix + this.options.states.error); // eslint-disable-line max-len
                    this.root.classList.remove(this.options.formStatePrefix + this.options.states.valid); // eslint-disable-line max-len
                    delete response.validationErrors.base; // eslint-disable-line no-param-reassign
                } else {
                    this.nodes.baseMessage.innerHTML = &apos;&apos;;
                }

                Object.keys(response.validationErrors).forEach(name =&gt;
                    JediValidate.markField(
                        this.fields[name],
                        this.messages[name],
                        this.options.states,
                        response.validationErrors[name],
                    ),
                );
            } else {
                try {
                    this.options.callbacks.success({ response });
                } catch (e) {
                    console.error(e);
                }

                if (this.options.redirect &amp;&amp; response.redirect) {
                    window.location.href = response.redirect;
                    return;
                }

                if (this.options.clean) {
                    this.nodes.form.reset();
                }
            }
        }).catch(({ method, url, status, statusText }) =&gt; {
            console.warn(`${method} ${url} ${status} (${statusText})`);

            this.nodes.baseMessage.innerHTML = this.translate(&apos;Can not send form!&apos;);
            this.root.classList.add(this.options.formStatePrefix + this.options.states.error); // eslint-disable-line max-len
            this.root.classList.remove(this.options.formStatePrefix + this.options.states.valid); // eslint-disable-line max-len
        });
    }

    /**
     * Collect data
     * @param {string|Array.&lt;string&gt;} params - field
     * @returns {Object}
     */
    collect(params = &apos;&apos;) {
        if (params) {
            if (Array.isArray(params)) {
                return params.reduce((collected, name) =&gt; {
                    const inputData = getInputData(this.inputs[name]);

                    this.data = {
                        ...this.data,
                        ...inputData,
                    };

                    return {
                        ...collected,
                        ...inputData,
                    };
                }, {});
            }

            const inputData = getInputData(this.inputs[params]);

            // fixme don&apos;t work with 2 inputs phone[]
            this.data = {
                ...this.data,
                ...inputData,
            };

            return inputData;
        }

        this.data = getData(this.inputs);

        return this.data;
    }

    /**
     *
     * @param {Element} field
     * @param message
     * @param states
     * @param errors
     */
    static markField(field, message, states, errors) {
        if (errors &amp;&amp; errors.length) {
            JediValidate.markError(field, message, states, errors);
        } else {
            JediValidate.markValid(field, message, states);
        }
    }

    /**
     * Mark field as invalid
     * @param {Element} field
     * @param {Element} message
     * @param {string} error
     * @param {string} valid
     * @param {Array.&lt;string&gt;} errors
     */
    static markError(field, message, { error, valid }, errors) {
        if (!field || !message) {
            return;
        }

        field.classList.add(error);
        field.classList.remove(valid);

        message.innerHTML = errors.join(&apos;, &apos;); // eslint-disable-line no-param-reassign
    }

    /**
     * Mark field as valid
     * @param {Element} field
     * @param {Element} message
     * @param {string} error
     * @param {string} valid
     */
    static markValid(field, message, { error, valid }) {
        if (!field || !message) {
            return;
        }

        field.classList.add(valid);
        field.classList.remove(error);

        message.innerHTML = &apos;&apos;; // eslint-disable-line no-param-reassign
    }

    /**
     * Add rule to validator
     * @param {string} rule - rule name
     * @param {Function} func - function
     * @param {string} message - error message
     */
    addMethod(rule, func, message) {
        this.methods[rule] = {
            func,
            message,
        };

        this.errorMessages = JediValidate.initErrorMessages(
            this.rules,
            this.options.messages,
            this.methods,
            this.options.language,
        );
    }

    /**
     * Add localisation to JediValidate
     * @param {string} sourceText - text on english
     * @param {string} translatedText - text on needed language
     * @param {string} language - language
     */
    addToDictionary(sourceText, translatedText, language) {
        this.dictionary.addTranslation(sourceText, translatedText, language);
    }

    /**
     * Init error messages
     * @param {object} rules
     * @param {object} messages
     * @param {object} methods
     * @returns {Object.&lt;string, Object.&lt;string, string&gt;&gt;}
     */
    static initErrorMessages(rules, messages, methods) {
        return Object.keys(rules).reduce((names, name) =&gt; ({
            ...names,
            [name]: Object.keys(rules[name]).reduce((ruleNames, method) =&gt; ({
                ...ruleNames,
                [method]: (messages[name] &amp;&amp; messages[name][method]) || (methods[method] &amp;&amp; methods[method].message) || &apos;&apos;,
            }), {}),
        }), {});
    }
}

module.exports = JediValidate;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
